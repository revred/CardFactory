@page "/checkout"
@using System.ComponentModel.DataAnnotations
@using System.IdentityModel.Tokens.Jwt
@inject IMakerClient MakerClient
@inject IAuthenticationService AuthenticationService
@inject NavigationManager Nav

<h2 class="mb-4">Checkout</h2>

@if (!isReady)
{
    <div class="d-flex align-items-center gap-2">
        <div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div>
        <span>Loading checkout…</span>
    </div>
}
else if (addresses.Count == 0)
{
    <div class="alert alert-info d-flex align-items-center justify-content-between">
        <div>
            You don’t have any saved addresses yet. Add one to continue.
        </div>
        <button class="btn btn-primary" @onclick="() => OpenEditor(new AddressDetails())">
            <i class="bi bi-plus-lg"></i> Add Address
        </button>
    </div>
}
else
{
    <div class="mb-3 d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Your Addresses</h5>
        <button class="btn btn-primary" @onclick="() => OpenEditor(new AddressDetails())">
            <i class="bi bi-plus-lg"></i> Add Address
        </button>
    </div>

    <div class="row g-3">
        @foreach (var addr in addresses)
        {
            var isSelected = selectedBarId == addr.BarID;
            <div class="col-12 col-md-6">
                <div class="card h-100 @(isSelected ? "border-success" : "")">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="form-check">
                                <input class="form-check-input"
                                       type="radio"
                                       name="selectedAddress"
                                       id="addr-@addr.BarID"
                                       checked="@isSelected"
                                       @onchange="@(_ => Select(addr.BarID))" />
                                <label class="form-check-label fw-semibold" for="addr-@addr.BarID">
                                    @(!string.IsNullOrWhiteSpace(addr.Site) ? addr.Site : "Unnamed")
                                </label>
                            </div>
                            <button type="button"
                                    class="btn btn-sm btn-outline-secondary"
                                    title="Edit"
                                    @onclick="() => OpenEditor(Clone(addr))">
                                <i class="bi bi-pencil"></i> Edit
                            </button>
                        </div>

                        <div class="mt-2 small text-muted">
                            @if (!string.IsNullOrWhiteSpace(addr.Address))
                            {
                                <div>@addr.Address</div>
                            }
                            <div>
                                @addr.State @((!string.IsNullOrWhiteSpace(addr.State) && (!string.IsNullOrWhiteSpace(addr.Pincode) || !string.IsNullOrWhiteSpace(addr.Country))) ? "," : "")
                                @addr.Pincode @((!string.IsNullOrWhiteSpace(addr.Pincode) && !string.IsNullOrWhiteSpace(addr.Country)) ? "," : "")
                                @addr.Country
                            </div>
                            @if (!string.IsNullOrWhiteSpace(addr.PhoneNumber))
                            {
                                <div>📞 @addr.PhoneNumber</div>
                            }
                            @if (!string.IsNullOrWhiteSpace(addr.Email))
                            {
                                <div>✉️ @addr.Email</div>
                            }
                        </div>
                    </div>

                    @if (isSelected)
                    {
                        <div class="card-footer bg-transparent border-0">
                            <button class="btn btn-success w-100" @onclick="ProceedWithSelected">
                                Proceed to Payment
                            </button>
                        </div>
                    }
                </div>
            </div>
        }
    </div>

    @if (selectedBarId == 0)
    {
        <div class="alert alert-warning mt-3">
            Please select an address to continue.
        </div>
        <button class="btn btn-success mt-2" disabled>Proceed to Payment</button>
    }
}

<!-- Address Editor Modal -->
@if (editing != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,.5);" role="dialog" aria-modal="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@((editing.BarID > 0) ? "Edit Address" : "Add Address")</h5>
                    <button type="button" class="btn-close" aria-label="Close" @onclick="CloseEditor"></button>
                </div>
                <EditForm Model="editorVm" OnValidSubmit="SaveAsync">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Site</label>
                                <InputText class="form-control" @bind-Value="editorVm.Site" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Email</label>
                                <InputText class="form-control" @bind-Value="editorVm.Email" />
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Phone Number</label>
                                <InputText class="form-control" @bind-Value="editorVm.PhoneNumber" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">State/City</label>
                                <InputText class="form-control" @bind-Value="editorVm.State" />
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">ZIP / Pincode</label>
                                <InputText class="form-control" @bind-Value="editorVm.Pincode" />
                            </div>
                            <div class="col-md-8">
                                <label class="form-label">Country</label>
                                <InputText class="form-control" @bind-Value="editorVm.Country" />
                            </div>

                            <div class="col-12">
                                <label class="form-label">Street Address</label>
                                <InputTextArea class="form-control" rows="3" @bind-Value="editorVm.Address" />
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button"
                                class="btn btn-outline-secondary"
                                @onclick="CloseEditor"
                                disabled="@saving">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary" disabled="@saving">
                            @if (saving)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            }
                            Save
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

@code {
    // State
    private bool isReady;
    private List<AddressDetails> addresses = new();
    private long selectedBarId;
    private AddressDetails? editing;
    private AddressEditorVm editorVm = new();
    private bool saving;

    protected override async Task OnInitializedAsync()
    {
        await LoadAddressesAsync();
        isReady = true;
    }

    private async Task LoadAddressesAsync()
    {
        addresses.Clear();

        var res = await MakerClient.GetAddressAsync();
        if (res?.AddressDetails != null)
        {
            addresses = res.AddressDetails.OrderByDescending(a => a.BarID).ToList();
            // Auto-select latest if any
            selectedBarId = addresses.FirstOrDefault()?.BarID ?? 0;
        }
    }

    private void Select(long barId) => selectedBarId = barId;

    private void ProceedWithSelected()
    {
        var addr = addresses.FirstOrDefault(a => a.BarID == selectedBarId);
        if (addr is null) return;

        // Pass only the "Address" string to /payment to keep your existing flow
        var addressBarID = addr.BarID.ToString() ?? "0";
        Nav.NavigateTo($"/payment?address={Uri.EscapeDataString(addressBarID)}");
    }

    private void OpenEditor(AddressDetails toEdit)
    {
        editing = toEdit;
        editorVm = AddressEditorVm.From(toEdit);

        // Prefill email if empty using the auth token (optional)
        if (string.IsNullOrWhiteSpace(editorVm.Email))
        {
            var email = GetEmailFromAccessToken(AuthenticationService.AccessToken);
            if (!string.IsNullOrWhiteSpace(email))
                editorVm.Email = email!;
        }
        StateHasChanged();
    }

    private void CloseEditor()
    {
        if (saving) return;
        editing = null;
        editorVm = new();
    }

    private async Task SaveAsync()
    {
        if (editing is null) return;

        saving = true;
        try
        {
            var req = new AddressRequest
            {
                BarID = editing.BarID, // 0 => create, >0 => update
                AddressDetails = new AddressDetails
                {
                    BarID = editing.BarID,
                    Email = editorVm.Email?.Trim() ?? "",
                    Site = editorVm.Site?.Trim() ?? "",
                    PhoneNumber = editorVm.PhoneNumber?.Trim() ?? "",
                    State = editorVm.State?.Trim() ?? "",
                    Pincode = editorVm.Pincode?.Trim() ?? "",
                    Country = editorVm.Country?.Trim() ?? "",
                    Address = editorVm.Address?.Trim() ?? ""
                }
            };

            await MakerClient.UpsertAddressAsync(req);

            // Refresh and close editor
            await LoadAddressesAsync();
        }
        catch (ApiException ex)
        {
            Console.Error.WriteLine(ex.Message);
        }
        finally
        {
            saving = false;
            //close modal only after saving flag reset
            CloseEditor();
            StateHasChanged(); // force rerender so modal disappears immediately
        }
    }

    private static AddressDetails Clone(AddressDetails a) => new()
    {
        BarID = a.BarID,
        Email = a.Email,
        Site = a.Site,
        PhoneNumber = a.PhoneNumber,
        State = a.State,
        Pincode = a.Pincode,
        Country = a.Country,
        Address = a.Address
    };

    private static string? GetEmailFromAccessToken(string? accessToken)
    {
        if (string.IsNullOrWhiteSpace(accessToken)) return null;
        var handler = new JwtSecurityTokenHandler();
        if (!handler.CanReadToken(accessToken)) return null;
        var jwt = handler.ReadJwtToken(accessToken);
        return jwt.Claims.FirstOrDefault(c =>
            c.Type == "email" || c.Type == JwtRegisteredClaimNames.Email)?.Value;
    }

    // ViewModel for modal editing with validation
    private class AddressEditorVm
    {
        public long BarID { get; set; }

        [Required, StringLength(200)]
        public string Site { get; set; } = string.Empty;

        [Required, EmailAddress, StringLength(200)]
        public string Email { get; set; } = string.Empty;

        [StringLength(50)]
        public string PhoneNumber { get; set; } = string.Empty;

        [StringLength(100)]
        public string State { get; set; } = string.Empty;

        [StringLength(20)]
        public string Pincode { get; set; } = string.Empty;

        [StringLength(100)]
        public string Country { get; set; } = string.Empty;

        [Required, StringLength(500)]
        public string Address { get; set; } = string.Empty;

        public static AddressEditorVm From(AddressDetails d) => new()
        {
            BarID = d.BarID,
            Site = d.Site ?? string.Empty,
            Email = d.Email ?? string.Empty,
            PhoneNumber = d.PhoneNumber ?? string.Empty,
            State = d.State ?? string.Empty,
            Pincode = d.Pincode ?? string.Empty,
            Country = d.Country ?? string.Empty,
            Address = d.Address ?? string.Empty
        };
    }
}
