@page "/verify"
@inject NavigationManager Nav
@inject CartService CartService
@inject IJSRuntime JSRuntime
@inject IAuthenticationService AuthenticationService

<h2>Email Verified ✅</h2>
<p>We're verifying your account. Please wait a moment...</p>

@code {
    protected override async Task OnInitializedAsync()
    {
        var uri = Nav.ToAbsoluteUri(Nav.Uri);
        var fragment = uri.Fragment;

        if (!string.IsNullOrWhiteSpace(fragment))
        {
            var queryParams = ParseFragment(fragment);
            if (queryParams.TryGetValue("refresh_token", out var refreshToken))
            {
                try
                {
                    var isRefreshed = await AuthenticationService.RefreshTokenAsync();

                    if (isRefreshed)
                    {
                        await CartService.SyncLocalCartToServerIfNeeded();

                        Nav.NavigateTo("/");
                        return;
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Verification login failed: {ex.Message}");
                    await JSRuntime.InvokeVoidAsync("alert", "Verification failed. Please try logging in manually.");
                }
            }
        }

        Nav.NavigateTo("/login");
    }

    private Dictionary<string, string> ParseFragment(string fragment)
    {
        if (fragment.StartsWith("#")) fragment = fragment[1..];
        return fragment
            .Split('&', StringSplitOptions.RemoveEmptyEntries)
            .Select(pair => pair.Split('=', 2))
            .Where(pair => pair.Length == 2)
            .ToDictionary(pair => Uri.UnescapeDataString(pair[0]), pair => Uri.UnescapeDataString(pair[1]));
    }
}
